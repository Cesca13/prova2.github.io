<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mini Chicken Invaders Mobile</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{
  margin:0;
  background:#000;
  color:white;
  font-family:Arial;
  text-align:center;
  overflow:hidden;
}

#game{
  position:relative;
  width:100vw;
  height:75vh;
  margin-top:10px;
  border:2px solid white;
  background:#6f6d6d;
  overflow:hidden;
  touch-action: none; /* per drag su mobile */
}

.player{
  position:absolute;
  bottom:80px;
  left:50%;
  transform:translateX(-50%);
  width:90px;  /* pi√π grande */
  height:90px; /* pi√π grande */
  border-radius:10px;
  overflow:hidden;
}

.player img{
  width:100%;
  height:100%;
  object-fit:contain;
  border-radius:10px;
}

.bullet {
  position: absolute;
  font-size: 36px;   /* missile pi√π grande */
  user-select: none;
}

.enemy {
  width:80px;  /* nemici pi√π grandi */
  height:80px;
  background-size: contain;
  background-repeat: no-repeat;
  position:absolute;
}

#info{
  margin-top:10px;
  font-size:22px;
}

button, select{
  padding:10px 25px;
  font-size:18px;
  margin:5px;
}

/* Touch controls */
#controls{
  position:fixed;
  bottom:10px;
  width:100%;
  display:flex;
  justify-content:center;
  gap:20px;
}

.control-btn{
  width:80px;
  height:80px;
  font-size:28px;
  border-radius:50%;
  background:#333;
  color:white;
  border:none;
  touch-action: manipulation;
}

/* Mobile responsive */
@media (max-width:600px){
  #info{ font-size:24px; }
  select, button{ font-size:20px; padding:15px 35px; min-width:180px; height:50px; }
}
</style>
</head>
<body>

<h1>üöÄ Mini Chicken Invaders</h1>

<select id="playerName">
  <option value="">Scegli il tuo nome</option>
  <option>Alice</option>
  <option>Bob</option>
  <option>Charlie</option>
  <option>Diana</option>
</select>

<button onclick="startGame()">START</button>

<div id="info">Punteggio: 0</div>
<div id="game"></div>

<div id="controls">
  <button class="control-btn" id="fire-btn">üî•</button>
</div>

<script>
const supabaseClient = supabase.createClient(
  "https://xloiaewcuwelufblecxf.supabase.co",
  "sb_publishable_SlM0ePMXPgoJjC47P8o-IQ_w6iEn_OP"
);

let score = 0;
let startTime;
let spawnInterval;
let bullets = [];
let enemies = [];
let currentPlayerName = "";
const TARGET_SCORE = 100;

let player, game;
let playerDragging = false;

// Nemici casuali
const enemySprites = [
  'https://xloiaewcuwelufblecxf.supabase.co/storage/v1/object/public/BFRA/morgan.gif',
  'https://xloiaewcuwelufblecxf.supabase.co/storage/v1/object/public/BFRA/alien1.png',
  'https://xloiaewcuwelufblecxf.supabase.co/storage/v1/object/public/BFRA/alien2.png'
];

function startGame(){
  const nameSelect = document.getElementById("playerName");
  currentPlayerName = nameSelect.value;
  if(!currentPlayerName){ alert("Seleziona un nome!"); return; }

  score = 0;
  updateInfo();
  startTime = performance.now();

  nameSelect.disabled = true;
  document.querySelector("button").disabled = true;

  game = document.getElementById("game");
  game.innerHTML = "";

  // crea player
  player = document.createElement("div");
  player.classList.add("player");
  const img = document.createElement("img");
  img.src = "https://xloiaewcuwelufblecxf.supabase.co/storage/v1/object/public/BFRA/bugo.gif";
  player.appendChild(img);
  game.appendChild(player);

  // spawn nemici continuo
  spawnInterval = setInterval(spawnEnemy, 600);

  // drag del player
  game.addEventListener("pointerdown", e=>{
    const rect = player.getBoundingClientRect();
    if(e.clientX >= rect.left && e.clientX <= rect.right &&
       e.clientY >= rect.top && e.clientY <= rect.bottom){
         playerDragging = true;
       }
  });

  game.addEventListener("pointermove", e=>{
    if(playerDragging){
      const rect = game.getBoundingClientRect();
      let newX = e.clientX - rect.left - player.offsetWidth/2;
      newX = Math.max(0, Math.min(game.clientWidth - player.offsetWidth, newX));
      player.style.left = newX + "px";
    }
  });

  game.addEventListener("pointerup", ()=>playerDragging=false);
  game.addEventListener("pointerleave", ()=>playerDragging=false);

  // pulsante fuoco
  document.getElementById("fire-btn").addEventListener("pointerdown", fireBullet);

  // loop di gioco
  requestAnimationFrame(gameLoop);
}

function updateInfo(){
  document.getElementById("info").innerText = `Punteggio: ${score} | Obiettivo: ${TARGET_SCORE}`;
}

// spawn nemici
function spawnEnemy(){
  const enemy = document.createElement("div");
  enemy.classList.add("enemy");
  const sprite = enemySprites[Math.floor(Math.random() * enemySprites.length)];
  enemy.style.backgroundImage = `url('${sprite}')`;
  enemy.style.left = Math.random() * (game.clientWidth - 80) + "px";
  enemy.style.top = "-80px";
  game.appendChild(enemy);
  enemies.push(enemy);

  // aumenta difficolt√† oltre 70 punti
  if(score >= 70){
    enemy.style.top = "-40px";
    enemy.style.height = "100px";
    enemy.style.width = "100px";
  }
}

function fireBullet(){
  const bullet = document.createElement("div");
  bullet.classList.add("bullet");
  bullet.innerText = "üöÄ";
  const playerLeft = parseFloat(player.style.left) || (game.clientWidth/2 - 45);
  bullet.style.left = playerLeft + player.offsetWidth/2 - 18 + "px";
  const playerTop = game.clientHeight - 80 - player.offsetHeight;
  bullet.style.top = playerTop + "px";
  game.appendChild(bullet);
  bullets.push(bullet);
}

function gameLoop(){
  const step = 10;
  let left = parseFloat(player.style.left) || (game.clientWidth/2 - 45);
  player.style.left = left + "px";

  // nemici
  enemies.forEach((enemy,i)=>{
    let top = parseFloat(enemy.style.top);
    enemy.style.top = top + 5 + "px";

    // collisione con player
    const eRect = enemy.getBoundingClientRect();
    const pRect = player.getBoundingClientRect();
    if(!(eRect.right < pRect.left || eRect.left > pRect.right || eRect.bottom < pRect.top || eRect.top > pRect.bottom)){
      score -= 15;
      updateInfo();
      enemy.remove();
      enemies.splice(i,1);
    }
  });

  // proiettili
  bullets.forEach((bullet,i)=>{
    let top = parseFloat(bullet.style.top);
    bullet.style.top = top - 15 + "px";

    enemies.forEach((enemy,j)=>{
      const eRect = enemy.getBoundingClientRect();
      const bRect = bullet.getBoundingClientRect();
      if(!(bRect.right < eRect.left || bRect.left > eRect.right || bRect.bottom < eRect.top || bRect.top > eRect.bottom)){
        score += 5;
        updateInfo();
        enemy.remove();
        bullet.remove();
        enemies.splice(j,1);
        bullets.splice(i,1);
      }
    });

    if(top < -20){
      bullet.remove();
      bullets.splice(i,1);
    }
  });

  if(score >= TARGET_SCORE){
    endGame();
    return;
  }

  requestAnimationFrame(gameLoop);
}

async function endGame(){
  clearInterval(spawnInterval);
  const timeElapsed = (performance.now() - startTime)/1000;

  await supabaseClient.from("invaders").insert({
    name: currentPlayerName,
    time: timeElapsed
  });

  alert(`Fine! Hai impiegato ${timeElapsed.toFixed(2)} secondi ü´∂üèª`);

  const nameSelect = document.getElementById("playerName");
  nameSelect.disabled = false;
  document.querySelector("button").disabled = false;

  game.innerHTML = "";
  bullets = [];
  enemies = [];
  updateInfo();
}
</script>

</body>
</html>
