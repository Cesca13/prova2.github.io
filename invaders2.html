<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Morgan Invaders</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{
  margin:0;
  background:#000;
  color:white;
  font-family:Arial;
  text-align:center;
  overflow:hidden;
}

#game{
  position:relative;
  width:100vw;
  height:60vh;
  margin-top:10px;
  border:2px solid white;
  overflow:hidden;
  background-image: url('https://xloiaewcuwelufblecxf.supabase.co/storage/v1/object/public/BFRA/invaders_sfondo.png');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}

.player{
  position:absolute;
  bottom:80px;
  left:50%;
  transform:translateX(-50%);
  width:80px;
  height:80px;
  border-radius:10px;
  overflow:hidden;
}

.player img{
  width:100%;
  height:100%;
  object-fit:contain;
  border-radius:10px;
}

.bullet {
  position: absolute;
  font-size: 32px;
  user-select: none;
}

.enemy {
  width:70px;
  height:70px;
  background-image: url('https://xloiaewcuwelufblecxf.supabase.co/storage/v1/object/public/BFRA/morgan.gif');
  background-size: contain;
  background-repeat: no-repeat;
  position:absolute;
}

#info{
  margin-top:10px;
  font-size:22px;
}

button, select{
  padding:10px 25px;
  font-size:18px;
  margin:5px;
}

#controls{
  position:fixed;
  bottom:20px;
  left:0;
  width:100%;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 25px;
  box-sizing:border-box;
  pointer-events:none;
}

.control-btn{
  width:130px;
  height:130px;
  font-size:48px;
  border-radius:50%;
  background:#222;
  color:white;
  border:3px solid white;
  touch-action:none;
  user-select:none;
  pointer-events:auto;
}

#fire-btn{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  bottom:0;
}

@media (max-width:600px){
  #info{ font-size:24px; }
  select, button{ font-size:20px; padding:15px 35px; min-width:180px; height:50px; }
}
</style>
</head>
<body>

<h1>üöÄ Morgan Invaders üöÄ</h1>

<select id="playerName">
  <option value="">Caricamento nomi...</option>
</select>

<button onclick="startGame()">START</button>

<div id="info">Punteggio: 0</div>
<div id="game"></div>

<div id="controls">
  <button class="control-btn" id="left-btn">‚¨ÖÔ∏è</button>
  <button class="control-btn" id="fire-btn">üî•</button>
  <button class="control-btn" id="right-btn">‚û°Ô∏è</button>
</div>

<script>
const supabaseClient = supabase.createClient(
  "https://xloiaewcuwelufblecxf.supabase.co",
  "sb_publishable_SlM0ePMXPgoJjC47P8o-IQ_w6iEn_OP"
);

let score = 0;
let startTime;
let spawnInterval;
let bullets = [];
let enemies = [];
let currentPlayerId = null;
let currentPlayerName = "";
const TARGET_SCORE = 100;

let player, game;
let moveLeft = false, moveRight = false;
let frenzyMode = false;
let enemySpeed = 4;

const enemySprites = ['https://xloiaewcuwelufblecxf.supabase.co/storage/v1/object/public/BFRA/morgan.gif'];

// --- Carica nomi disponibili dalla tabella ---
async function loadPlayerNames(){
  const select = document.getElementById("playerName");
  select.innerHTML = '<option value="">Scegli il tuo nome</option>';

  const { data: players, error } = await supabaseClient
    .from('players')
    .select('id, player')
    .is('MorganInvaders', null);

  if(error){
    console.error(error);
    select.innerHTML = '<option value="">Errore caricamento</option>';
    return;
  }

  players.forEach(p=>{
    const option = document.createElement('option');
    option.value = p.id;
    option.textContent = p.player;
    select.appendChild(option);
  });
}

// --- START GAME ---
async function startGame(){
  const nameSelect = document.getElementById("playerName");
  currentPlayerId = nameSelect.value;
  currentPlayerName = nameSelect.options[nameSelect.selectedIndex].text;
  if(!currentPlayerId){ alert("Seleziona un nome!"); return; }

  // aggiorna colonna MorganInvaders con data/ora corrente
  const now = new Date().toISOString();
  const { data, error } = await supabaseClient
    .from('players')
    .update({ MorganInvaders: now })
    .eq('id', currentPlayerId);

  if(error){
    console.error("Errore aggiornando il record:", error);
    return;
  }

  // rimuove il nome dalla dropdown
  const option = nameSelect.querySelector(`option[value="${currentPlayerId}"]`);
  if(option) option.remove();
  nameSelect.disabled = true;
  document.querySelector("button").disabled = true;

  // reset game
  score = 0;
  updateInfo();
  startTime = performance.now();
  frenzyMode = false;
  enemySpeed = 4;

  game = document.getElementById("game");
  game.innerHTML = "";

  // crea player
  player = document.createElement("div");
  player.classList.add("player");
  const img = document.createElement("img");
  img.src = "https://xloiaewcuwelufblecxf.supabase.co/storage/v1/object/public/BFRA/bugos.gif";
  player.appendChild(img);
  game.appendChild(player);

  spawnInterval = setInterval(spawnEnemy, 800);
  requestAnimationFrame(gameLoop);

  // touch controls
  const leftBtn = document.getElementById("left-btn");
  const rightBtn = document.getElementById("right-btn");
  const fireBtn = document.getElementById("fire-btn");

  leftBtn.addEventListener("pointerdown", ()=>moveLeft=true);
  leftBtn.addEventListener("pointerup", ()=>moveLeft=false);
  rightBtn.addEventListener("pointerdown", ()=>moveRight=true);
  rightBtn.addEventListener("pointerup", ()=>moveRight=false);
  fireBtn.addEventListener("pointerdown", fireBullet);

  game.addEventListener("pointerdown", startDrag);
  game.addEventListener("pointermove", dragPlayer);
  game.addEventListener("pointerup", endDrag);
}

// --- Update punteggio ---
function updateInfo(){
  document.getElementById("info").innerText = `Punteggio: ${score} | Obiettivo: ${TARGET_SCORE}`;
}

// --- Spawn nemici ---
function spawnEnemy(){
  const enemy = document.createElement("div");
  enemy.classList.add("enemy");
  enemy.style.backgroundImage = `url('${enemySprites[0]}')`;
  enemy.style.left = Math.random()*(game.clientWidth-70) + "px";
  enemy.style.top = "-70px";
  game.appendChild(enemy);
  enemies.push(enemy);
}

// --- Fire bullet ---
function fireBullet(){
  const bullet = document.createElement("div");
  bullet.classList.add("bullet");
  bullet.innerText = "üöÄ";

  const playerLeft = parseFloat(player.style.left) || (game.clientWidth/2 - 40);
  bullet.style.left = playerLeft + player.offsetWidth/2 - 16 + "px";
  bullet.style.top = game.clientHeight - 80 - player.offsetHeight + "px";

  game.appendChild(bullet);
  bullets.push(bullet);
}

// --- Drag player ---
let dragging = false;
function startDrag(e){ dragging = true; dragPlayer(e); }
function dragPlayer(e){
  if(!dragging) return;
  let x = e.clientX - player.offsetWidth/2;
  x = Math.max(0, Math.min(game.clientWidth - player.offsetWidth, x));
  player.style.left = x + "px";
}
function endDrag(){ dragging = false; }

// --- Game loop ---
function gameLoop(){
  const step = 10;
  let left = parseFloat(player.style.left) || (game.clientWidth/2 - 40);
  if(moveLeft) left -= step;
  if(moveRight) left += step;
  left = Math.max(0, Math.min(game.clientWidth - player.offsetWidth, left));
  player.style.left = left + "px";

  if(score >= 70 && !frenzyMode){
    frenzyMode = true;
    enemySpeed = 7;
    clearInterval(spawnInterval);
    spawnInterval = setInterval(spawnEnemy, 300);
  }

  // nemici
  enemies.forEach((enemy,i)=>{
    let top = parseFloat(enemy.style.top);
    enemy.style.top = top + enemySpeed + "px";

    const eRect = enemy.getBoundingClientRect();
    const pRect = player.getBoundingClientRect();
    if(!(eRect.right < pRect.left || eRect.left > pRect.right || eRect.bottom < pRect.top || eRect.top > pRect.bottom)){
      score -= 15;
      updateInfo();
      enemy.remove();
      enemies.splice(i,1);
    }
    if(top > game.clientHeight){
      enemy.remove();
      enemies.splice(i,1);
    }
  });

  // proiettili
  bullets.forEach((bullet,i)=>{
    let top = parseFloat(bullet.style.top);
    bullet.style.top = top - 12 + "px";

    enemies.forEach((enemy,j)=>{
      const eRect = enemy.getBoundingClientRect();
      const bRect = bullet.getBoundingClientRect();
      if(!(bRect.right < eRect.left || bRect.left > eRect.right || bRect.bottom < eRect.top || bRect.top > eRect.bottom)){
        score += 10;
        updateInfo();
        enemy.remove();
        bullet.remove();
        enemies.splice(j,1);
        bullets.splice(i,1);
      }
    });

    if(top < -20){
      bullet.remove();
      bullets.splice(i,1);
    }
  });

  if(score >= TARGET_SCORE){
    endGame();
    return;
  }

  requestAnimationFrame(gameLoop);
}

// --- End game ---
async function endGame(){
  clearInterval(spawnInterval);

  const timeElapsed = (performance.now() - startTime)/1000;

  // salva su tabella invaders
  await supabaseClient.from('invaders').insert({
    name: currentPlayerName,
    time: timeElapsed
    // created_at viene gestito automaticamente
  });

  alert(`Fine! Alla prossima üòé`);

  const nameSelect = document.getElementById("playerName");
  nameSelect.disabled = false;
  document.querySelector("button").disabled = false;

  game.innerHTML = "";
  bullets = [];
  enemies = [];
  frenzyMode = false;
  enemySpeed = 4;
  updateInfo();
}

// --- Carica nomi all'avvio ---
loadPlayerNames();
</script>

</body>
</html>
