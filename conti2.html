<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Conti-Click</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  background:#111;
  color:white;
  font-family:Arial;
  text-align:center;
}

#game{
  position:relative;
  width:100vw;
  height:75vh;
  border:2px solid white;
  overflow:hidden;
  margin-top:20px;
  background: url('https://xloiaewcuwelufblecxf.supabase.co/storage/v1/object/public/BFRA/conticlick_sfondo.png') center/cover no-repeat;
  opacity: 0.5;
}

.target{
  position:absolute;
  width:100px;
  height:100px;
  border-radius:50%;
  cursor:pointer;
  touch-action: manipulation;
}

#info{
  margin-top:10px;
  font-size:22px;
}

button, select{
  padding:10px 25px;
  font-size:18px;
  margin:5px;
}

@media (max-width: 600px) {
  body { font-size: 18px; }
  h1 { font-size: 28px; }
  #info { font-size: 24px; }
  select, button { font-size: 20px; padding: 15px 35px; min-width: 180px; height: 50px; border-radius: 8px; appearance: none; -webkit-appearance:none; -moz-appearance:none; text-align:center; }
}
</style>
</head>
<body>

<h1>ðŸŽ¯ Conti-Click</h1>

<select id="playerName">
  <option value="">Caricamento nomi...</option>
</select>

<button onclick="startGame()">START</button>

<div id="info">Punteggio: 0</div>
<div id="game"></div>

<script>
const supabaseClient = supabase.createClient(
  "https://xloiaewcuwelufblecxf.supabase.co",
  "sb_publishable_SlM0ePMXPgoJjC47P8o-IQ_w6iEn_OP"
);

let score = 0;
let startTime;
let timerInterval;
let spawnInterval;
let currentPlayerId = null;
let currentPlayerName = "";
let spawnDelay = 500;
let targetsPerSpawn = 2;
let badProbability = 0.5;
const TARGET_SCORE = 100;

const goodTargets = [
  'https://xloiaewcuwelufblecxf.supabase.co/storage/v1/object/public/BFRA/CC1.png',
  'https://xloiaewcuwelufblecxf.supabase.co/storage/v1/object/public/BFRA/CC2.png',
  'https://xloiaewcuwelufblecxf.supabase.co/storage/v1/object/public/BFRA/CC3.png'
];

const badTargets = [
  'https://xloiaewcuwelufblecxf.supabase.co/storage/v1/object/public/BFRA/AM1.png',
  'https://xloiaewcuwelufblecxf.supabase.co/storage/v1/object/public/BFRA/AM2.png',
  'https://xloiaewcuwelufblecxf.supabase.co/storage/v1/object/public/BFRA/AM3.png'
];

// --- Carica nomi dalla tabella players ---
async function loadPlayerNames(){
  const select = document.getElementById("playerName");
  select.innerHTML = '<option value="">Scegli il tuo nome</option>';

  const { data: players, error } = await supabaseClient
    .from('players')
    .select('id, player')
    .is('ContiClick', null);

  if(error){
    console.error(error);
    select.innerHTML = '<option value="">Errore caricamento</option>';
    return;
  }

  players.forEach(p=>{
    const option = document.createElement('option');
    option.value = p.id; // salviamo l'id per aggiornare la colonna ContiClick
    option.textContent = p.player; // mostriamo il nome reale
    select.appendChild(option);
  });
}

// --- Start Game ---
async function startGame(){
  const nameSelect = document.getElementById("playerName");
  currentPlayerId = nameSelect.value;
  if(!currentPlayerId){
    alert("Seleziona un nome prima di iniziare!");
    return;
  }

  // Recupera il nome reale del giocatore
  const { data: playerData, error: playerError } = await supabaseClient
    .from('players')
    .select('player')
    .eq('id', currentPlayerId)
    .single();

  if(playerError || !playerData){
    console.error("Errore recuperando il nome del giocatore", playerError);
    return;
  }
  currentPlayerName = playerData.player;

  // Aggiorna colonna ContiClick con data/ora corrente
  const now = new Date().toISOString();
  const { error: updateError } = await supabaseClient
    .from('players')
    .update({ ContiClick: now })
    .eq('id', currentPlayerId);

  if(updateError){
    console.error("Errore aggiornando ContiClick", updateError);
    return;
  }

  // Rimuove il nome dalla dropdown
  const option = nameSelect.querySelector(`option[value="${currentPlayerId}"]`);
  if(option) option.remove();
  nameSelect.disabled = true;
  document.querySelector("button").disabled = true;

  // --- Inizio del gioco ---
  score = 0;
  startTime = performance.now();
  spawnDelay = 500;
  targetsPerSpawn = 2;
  badProbability = 0.5;

  updateInfo();

  timerInterval = setInterval(updateInfo, 200);
  spawnInterval = setInterval(dynamicSpawn, spawnDelay);
}

function updateInfo(){
  document.getElementById("info").innerText =
    `Punteggio: ${score} | Obiettivo: ${TARGET_SCORE}`;
}

// --- Spawn dinamico ---
function dynamicSpawn(){
  for(let i=0; i<targetsPerSpawn; i++){
    createTarget();
  }

  if(score >= 30 && score < 60){
    spawnDelay = 400;
    targetsPerSpawn = 3;
    badProbability = 0.6;
  } else if(score >= 60 && score < 90){
    spawnDelay = 300;
    targetsPerSpawn = 4;
    badProbability = 0.7;
  } else if(score >= 90){
    spawnDelay = 200;
    targetsPerSpawn = 5;
    badProbability = 0.8;
  }

  clearInterval(spawnInterval);
  spawnInterval = setInterval(dynamicSpawn, spawnDelay);
}

function createTarget(){
  const game = document.getElementById("game");
  const target = document.createElement("div");
  target.classList.add("target");

  const isGood = Math.random() < (1 - badProbability);
  const imgArray = isGood ? goodTargets : badTargets;
  const img = imgArray[Math.floor(Math.random() * imgArray.length)];

  target.style.backgroundImage = `url('${img}')`;
  target.style.backgroundSize = "cover";
  target.style.backgroundPosition = "center";
  target.style.backgroundRepeat = "no-repeat";

  const x = Math.random() * (game.clientWidth - 100);
  const y = Math.random() * (game.clientHeight - 100);
  target.style.left = x + "px";
  target.style.top = y + "px";

  target.addEventListener("pointerdown", (e)=>{
    e.preventDefault();
    if(isGood){
      score += 10;
    } else {
      score -= 15;
    }
    updateInfo();
    if(score >= TARGET_SCORE){
      endGame();
    }
    target.remove();
  });

  game.appendChild(target);
  setTimeout(()=> target.remove(), 2000);
}

async function endGame(){
  clearInterval(timerInterval);
  clearInterval(spawnInterval);

  const duration = (performance.now() - startTime) / 1000;

  // Salva punteggio nella tabella scores con il nome reale
  await supabaseClient.from("scores").insert({
    name: currentPlayerName,
    score: score,
    duration: duration
  });

  alert(`Fine! Grazie per aver giocato ðŸ«¶ðŸ»`);

  const nameSelect = document.getElementById("playerName");
  const optionToRemove = Array.from(nameSelect.options)
    .find(opt => opt.value === currentPlayerId);
  if(optionToRemove) optionToRemove.remove();

  nameSelect.value = "";
  nameSelect.disabled = false;
  document.querySelector("button").disabled = false;

  document.getElementById("game").innerHTML = "";
  updateInfo();
}

// --- Carica nomi all'avvio ---
loadPlayerNames();
</script>

</body>
</html>
