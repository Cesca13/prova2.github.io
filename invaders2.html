<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mini Chicken Invaders Mobile</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{
  margin:0;
  background:#000;
  color:white;
  font-family:Arial;
  text-align:center;
  overflow:hidden;
  user-select: none; /* disabilita selezione del testo */
}

#game{
  position:relative;
  width:100vw;
  height:75vh;
  margin-top:10px;
  border:2px solid white;
  background:#6f6d6d;
  overflow:hidden;
}

.player{
  position:absolute;
  bottom:100px;
  left:50%;
  transform:translateX(-50%);
  width:100px;
  height:100px;
  border-radius:10px;
  overflow:hidden;
}

.player img{
  width:100%;
  height:100%;
  object-fit:contain;
  border-radius:10px;
}

.bullet {
  position: absolute;
  font-size: 36px;
  user-select: none;
}

.enemy {
  width:80px;
  height:80px;
  background-image: url('https://xloiaewcuwelufblecxf.supabase.co/storage/v1/object/public/BFRA/morgan.gif');
  background-size: contain;
  background-repeat: no-repeat;
  position:absolute;
}

#info{
  margin-top:10px;
  font-size:26px;
}

button, select{
  padding:12px 30px;
  font-size:20px;
  margin:5px;
}

/* Touch controls */
#controls{
  position:fixed;
  bottom:10px;
  width:100%;
  display:flex;
  justify-content:center;
  gap:40px;
}

.control-btn{
  width:100px;
  height:100px;
  font-size:36px;
  border-radius:50%;
  background:#333;
  color:white;
  border:none;
  touch-action: none; /* importante per multi-touch */
}

/* Mobile responsive */
@media (max-width:600px){
  #info{ font-size:24px; }
  select, button{ font-size:20px; padding:15px 35px; min-width:180px; height:50px; }
  .control-btn{ width:90px; height:90px; font-size:32px; }
}
</style>
</head>
<body>

<h1>üöÄ Mini Chicken Invaders</h1>

<select id="playerName">
  <option value="">Scegli il tuo nome</option>
  <option>Alice</option>
  <option>Bob</option>
  <option>Charlie</option>
  <option>Diana</option>
</select>

<button onclick="startGame()">START</button>

<div id="info">Punteggio: 0</div>
<div id="game"></div>

<div id="controls">
  <button class="control-btn" id="left-btn">‚¨ÖÔ∏è</button>
  <button class="control-btn" id="fire-btn">üî•</button>
  <button class="control-btn" id="right-btn">‚û°Ô∏è</button>
</div>

<script>
const supabaseClient = supabase.createClient(
  "https://xloiaewcuwelufblecxf.supabase.co",
  "sb_publishable_SlM0ePMXPgoJjC47P8o-IQ_w6iEn_OP"
);

let score = 0;
let startTime;
let spawnInterval;
let spawnDelay = 600;
let bullets = [];
let enemies = [];
let currentPlayerName = "";
const TARGET_SCORE = 100;

let player, game;
let moveLeft = false, moveRight = false;

// Nemico unico
let enemy;

function startGame(){
  const nameSelect = document.getElementById("playerName");
  currentPlayerName = nameSelect.value;
  if(!currentPlayerName){ alert("Seleziona un nome!"); return; }

  score = 0;
  spawnDelay = 600;
  updateInfo();
  startTime = performance.now();

  nameSelect.disabled = true;
  document.querySelector("button").disabled = true;

  game = document.getElementById("game");
  game.innerHTML = "";

  // crea player
  player = document.createElement("div");
  player.classList.add("player");
  const img = document.createElement("img");
  img.src = "https://xloiaewcuwelufblecxf.supabase.co/storage/v1/object/public/BFRA/bugo.gif";
  player.appendChild(img);
  game.appendChild(player);

  // spawn nemico
  spawnEnemy();
  spawnInterval = setInterval(spawnEnemy, spawnDelay);

  // movimento player
  requestAnimationFrame(gameLoop);

  // multi-touch controlli
  document.getElementById("left-btn").addEventListener("pointerdown", ()=>moveLeft=true);
  document.getElementById("left-btn").addEventListener("pointerup", ()=>moveLeft=false);
  document.getElementById("right-btn").addEventListener("pointerdown", ()=>moveRight=true);
  document.getElementById("right-btn").addEventListener("pointerup", ()=>moveRight=false);
  document.getElementById("fire-btn").addEventListener("pointerdown", fireBullet);
}

function updateInfo(){
  document.getElementById("info").innerText = `Punteggio: ${score} | Obiettivo: ${TARGET_SCORE}`;
}

// spawn nemico unico
function spawnEnemy(){
  if(enemy) return; // esiste gi√†

  enemy = document.createElement("div");
  enemy.classList.add("enemy");
  enemy.style.left = Math.random() * (game.clientWidth - 80) + "px";
  enemy.style.top = "-80px";
  game.appendChild(enemy);
  enemies.push(enemy);
}

function fireBullet(){
  const bullet = document.createElement("div");
  bullet.classList.add("bullet");
  bullet.innerText = "üöÄ";

  const playerLeft = parseFloat(player.style.left) || (game.clientWidth/2 - 50);
  bullet.style.left = playerLeft + player.offsetWidth/2 - 18 + "px";

  const playerTop = game.clientHeight - 100 - player.offsetHeight;
  bullet.style.top = playerTop + "px";

  game.appendChild(bullet);
  bullets.push(bullet);
}

function gameLoop(){
  const step = 10;
  let left = parseFloat(player.style.left) || (game.clientWidth/2 - 50);
  if(moveLeft) left -= step;
  if(moveRight) left += step;
  left = Math.max(0, Math.min(game.clientWidth - player.offsetWidth, left));
  player.style.left = left + "px";

  // nemico
  enemies.forEach((e,i)=>{
    let top = parseFloat(e.style.top);
    e.style.top = top + 5 + "px";

    // collisione con player
    const eRect = e.getBoundingClientRect();
    const pRect = player.getBoundingClientRect();
    if(!(eRect.right < pRect.left || eRect.left > pRect.right || eRect.bottom < pRect.top || eRect.top > pRect.bottom)){
      score -= 15;
      updateInfo();
      e.remove();
      enemies.splice(i,1);
      enemy = null;
    }

    if(top > game.clientHeight){
      e.remove();
      enemies.splice(i,1);
      enemy = null;
    }
  });

  // proiettili
  bullets.forEach((b,i)=>{
    let top = parseFloat(b.style.top);
    b.style.top = top - 12 + "px";

    // collisione con nemico
    enemies.forEach((e,j)=>{
      const eRect = e.getBoundingClientRect();
      const bRect = b.getBoundingClientRect();
      if(!(bRect.right < eRect.left || bRect.left > eRect.right || bRect.bottom < eRect.top || bRect.top > eRect.bottom)){
        score += 10;
        updateInfo();
        e.remove();
        b.remove();
        enemies.splice(j,1);
        bullets.splice(i,1);
        enemy = null;
      }
    });

    if(top < -40){
      b.remove();
      bullets.splice(i,1);
    }
  });

  // aumenta frequenza nemico oltre 70 punti
  if(score >= 70 && spawnDelay !== 400){
    spawnDelay = 400;
    clearInterval(spawnInterval);
    spawnInterval = setInterval(spawnEnemy, spawnDelay);
  }

  if(score >= TARGET_SCORE){
    endGame();
    return;
  }

  requestAnimationFrame(gameLoop);
}

async function endGame(){
  clearInterval(spawnInterval);
  const timeElapsed = (performance.now() - startTime)/1000;

  await supabaseClient.from("invaders").insert({
    name: currentPlayerName,
    time: timeElapsed
  });

  alert(`Fine! Hai impiegato ${timeElapsed.toFixed(2)} secondi ü´∂üèª`);

  const nameSelect = document.getElementById("playerName");
  nameSelect.disabled = false;
  document.querySelector("button").disabled = false;

  game.innerHTML = "";
  bullets = [];
  enemies = [];
  enemy = null;
  updateInfo();
}
</script>

</body>
</html>
